name: Quality Gates

on:
  pull_request:
    branches: [ main, test ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: TypeScript compilation check
      run: npx tsc --noEmit
      
    - name: Build validation
      run: |
        npm run build
        
        # Validate no TS files in output
        if find dist -name "*.ts" | grep -q .; then
          echo "❌ TypeScript files found in dist"
          exit 1
        fi
        
        # Validate all pages exist
        for page in index team research sources support coming_soon; do
          test -f "dist/${page}.html" || { echo "❌ Missing ${page}.html"; exit 1; }
        done
        
        echo "✅ Build validation passed"
        
    - name: Bundle size check
      run: |
        DIST_SIZE=$(du -sb dist | cut -f1)
        MAX_SIZE=5242880  # 5MB
        
        if [ $DIST_SIZE -gt $MAX_SIZE ]; then
          echo "❌ Bundle too large: $(($DIST_SIZE / 1024 / 1024))MB > 5MB"
          exit 1
        fi
        
        echo "✅ Bundle size OK: $(($DIST_SIZE / 1024))KB"

  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Security audit
      run: |
        npm audit --audit-level=moderate
        
    - name: Check for secrets
      run: |
        # Basic secret scanning
        if grep -r -i "password\|secret\|key\|token" --include="*.ts" --include="*.js" --include="*.html" .; then
          echo "⚠️  Potential secrets found - review manually"
        fi